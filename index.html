<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
</head>

<body>
    <div id="wrap">
        <div id="mask"></div>
        <section id="modal">
            <div id="modal_title" align="center">
                <img src="vagina.png" alt="vagina" title="vagina">
            </div>
            <div id="message">
                <p>1.Reach orgasm when your fingers touch very slowly.
                    <br>2.You need to find the best position.
                    <br>3.Sounds and line graphs will help.
                    <br>4.Feel the change with movement.
                    <br>
                    <br>1.ゆっくりとした指使いが、オーガズムに達します。
                    <br>2.ベストの位置を探す必要があります。
                    <br>3.音と線グラフが助けになるでしょ。
                    <br>4.動きによっての変化を感じてください。
                </p>
            </div>
            <div id="close">
                LOADING...
            </div>
            <br>
            <div id="qr_code" align="center">
                <img src="qr_code.png" alt="qr_code" title="qr_code">
            </div>
        </section>
        <div id="top">
            <canvas id="graph" width="380" height="100"></canvas>
        </div>
        <div id="top">
            <canvas id="canvas1" width="380" height="570"></canvas>
        </div>
    </div>
</body>

</html>
<style>
    #wrap {
        user-select: none;
    }

    body {
        background-color: black;
    }

    canvas {
        vertical-align: bottom;
        font-size: 0px;
    }

    #top {
        text-align: center;
        margin: 0;
        padding: 0;
        vertical-align: bottom;
    }

    #qr_code {
        display: block;
        top: 100;
        left: 0;
        width: 100%;
        height: auto;
        text-align: center;
        margin: 0;
        padding: 0;
    }

    #close {
        cursor: pointer;
        width: 200px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        padding: 6px;
        margin: 6px auto 0;
        background: rgba(112, 112, 112, 0.4);
        color: white;
        position: relative;
        top: 30%;
    }

    #mask {
        animation: fadeIn 2.0s ease-in 0s forwards;
        background: rgba(0, 0, 0, 0.4);
        position: fixed;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
        z-index: 1;
    }

    #modal {
        animation: fadeIn 1.0s ease-in 0s forwards;
        background: rgba(26, 87, 130, 0.6);
        background-image: url("./girl_png/girl001.png");
        background-repeat: no-repeat;
        background-position: center center;

        color: rgb(168, 168, 168);
        width: 300px;
        padding: 10px;
        border-radius: 4px;
        position: fixed;
        top: 45%;
        left: 50%;
        transform: translate(-50%, -50%);
        -webkit-transform: translate(-50%, -50%);
        -ms-transform: translate(-50%, -50%);
        margin: 0 auto;
        z-index: 2;
    }

    @keyframes fadeIn {
        0% {
            display: none;
            opacity: 0;
        }

        1% {
            display: block;
            opacity: 0;
        }

        100% {
            display: block;
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        0% {
            display: block;
            opacity: 1;
        }

        1% {
            display: block;
            opacity: 1;
        }

        100% {
            display: none;
            opacity: 0;
        }
    }

    #modal p {
        margin: 0 0 20px;
    }

    #mask.hidden {
        animation: fadeOut 0.3s ease-in 0s forwards;
        display: none;

    }

    #modal.hidden {
        animation: fadeOut 0.3s ease-in 0s forwards;
        display: none;
    }
</style>

<script>
    //Reset
    window.addEventListener('touchmove', function (event) {
        event.preventDefault();
    }, { passive: false });

    /* -----------------------------------------------------------------
    言語の取得
    -------------------------------------------------------------------- */
    var language = (window.navigator.languages && window.navigator.languages[0]) ||
        window.navigator.language ||
        window.navigator.userLanguage ||
        window.navigator.browserLanguage;

    /* -----------------------------------------------------------------
    ヴァギナを触って、オーガズムに達してください。早く動かすよりもゆっくり動かすほうが感じます。
    動かしながらランダムに位置が変わる感じるポイントを探してください。
    感じるポイントは、声が大きくなり、赤いグラフが上昇します。
    そのポイントを指で触りながら、オーガズムに導いてください。
    -------------------------------------------------------------------- */

    if (language == "ja") {
        document.getElementById("message").innerHTML = "<p><br>Touch the vagina to reach orgasm. It feels better to move slowly than to move fast.<br>Look for a point where you can feel the position change randomly while moving.<br>The point you feel is that your voice becomes louder and the red graph rises.<br>Please guide to orgasm while touching that point with your finger.</p>";
    }
    else {
        document.getElementById("message").innerHTML = "<p><br>ヴァギナを触って、オーガズムに達してください。早く動かすよりもゆっくり動かすほうが感じます。<br>動かしながらランダムに位置が変わる感じるポイントを探してください。<br>感じるポイントは、声が大きくなり、赤いグラフが上昇します。<br>そのポイントを指で触りながら、オーガズムに導いてください。</p>";
    }


    /* -----------------------------------------------------------------
    スタートの警告
    -------------------------------------------------------------------- */

    window.addEventListener("load", function () {
        // 実行したい処理
        modal.classList.remove('hidden');
        mask.classList.remove('hidden');
    });

    const close = document.getElementById('close');
    const modal = document.getElementById('modal');
    const mask = document.getElementById('mask');

    var x_margin = document.getElementById("canvas1").getBoundingClientRect().left;
    var y_margin = document.getElementById("canvas1").getBoundingClientRect().top;

    var myStart;
    var myStop;
    var playing;

    function click_func() {
        close.addEventListener('click', function () {
            myStart = new Date();

            modal.classList.add('hidden');
            mask.classList.add('hidden');

            // var music = new Audio();
            // music.src = './Super Nova.mp3'; // 音声ファイルの指定
            // music.load(); // audioの読み込み
            // music.play();
            o_value = 0.0;
            Dist0 = 0;
            Dist1 = 0;
            dragging = false;
            playing = true;

            arr = [];
            _arr = [];

            h1_point.x = canvas.width * 0.5 + Math.floor((Math.random() * 2 - 1) * 14);
            h1_point.y = canvas.height * 0.2 + Math.floor((Math.random() * 2 - 1) * 14);
            h2_point_x = canvas.width * 0.5 + Math.floor((Math.random() * 2 - 1) * (canvas.width - x_margin) * 0.05);
            h2_point.y = canvas.height * 0.6 + Math.floor((Math.random() * 2 - 1) * (canvas.height - y_margin) * 0.2);
            h3_point_x = canvas.width * 0.5 + Math.floor((Math.random() * 2 - 1) * (canvas.width - x_margin) * 0.05);
            h3_point.y = canvas.height * 0.6 + Math.floor((Math.random() * 2 - 1) * (canvas.height - y_margin) * 0.2);
            h1_point.alpha = 0.5;
            h2_point.alpha = 0.5;
            h3_point.alpha = 0.5;

            previous_num1 = Math.floor(Math.random() * voice_list1.length);
            voice_list1[previous_num1].currentTime = voice_list1[previous_num1].duration;

            previous_num2 = Math.floor(Math.random() * voice_list2.length);
            voice_list2[previous_num2].currentTime = voice_list2[previous_num2].duration;

            stopwatch_time = 20;

        });
    };

    /* -----------------------------------------------------------------
    各種オブジェクトの作成
    -------------------------------------------------------------------- */
    var canvas = document.getElementById("canvas1");
    var _canvas = document.getElementById("graph");
    var ctx = canvas.getContext('2d');
    var _ctx = _canvas.getContext('2d');

    var stage = new createjs.Stage(canvas); // Stage クラスのインスタンスを作成する
    //var _stage = new createjs.Stage(_canvas); // Stage クラスのインスタンスを作成する

    // var stopW_text = new createjs.Text("Time:", "20px Arial", "#ff7700"); // Text クラスのインスタンスを作成する
    // stopW_text.textAlign = "end";
    // stopW_text.x = canvas.width * 0.9;
    // stopW_text.y = -canvas.height * 0.1;

    var h2_point_x = 0;
    var h3_point_x = 0;

    //クリトリスまる
    var circle = new createjs.Shape();
    circle.graphics.beginFill("rgb(222, 60, 92)").drawCircle(0, 0, 14);
    circle.x = canvas.width * 0.5;
    circle.y = canvas.height * 0.2;
    circle.scaleY = 1.6;
    circle.alpha = 0.0;

    var h1_point = new createjs.Shape();
    h1_point.graphics.beginFill("rgb(222, 255, 92)").drawCircle(0, 0, 10);
    h1_point.alpha = 0.0;

    var h2_point = new createjs.Shape();
    h2_point.graphics.beginFill("rgb(222, 255, 92)").drawCircle(0, 0, 10);
    h2_point.alpha = 0.0;

    var h3_point = new createjs.Shape();
    h3_point.graphics.beginFill("rgb(0, 255, 92)").drawCircle(0, 0, 10);
    h3_point.alpha = 0.0;

    // alpha
    var purple_graphics = new createjs.Graphics();
    purple_graphics
        .beginRadialGradientFill(["#ff00ff", "#000000"], [0, 0.5], canvas.width * 0.5, canvas.height * 0.5, 0, canvas.width * 0.5, canvas.height * 0.5, 640)
        .drawRect(0, 0, canvas.width, canvas.height);
    purple_circle = new createjs.Shape(purple_graphics);
    purple_circle.alpha = 0.0;

    var red_graphics = new createjs.Graphics();
    red_graphics
        .beginRadialGradientFill(["#c40000", "#000000"], [0, 0.5], canvas.width * 0.5, canvas.height * 0.5, 0, canvas.width * 0.5, canvas.height * 0.5, 640)
        .drawRect(0, 0, canvas.width, canvas.height);
    red_circle = new createjs.Shape(red_graphics);
    red_circle.alpha = 0.0;

    var white_graphics = new createjs.Graphics();
    white_graphics
        .beginRadialGradientFill(["#ffffff", "#000000"], [0, 0.5], canvas.width * 0.5, canvas.height * 0.5, 0, canvas.width * 0.5, canvas.height * 0.5, 640)
        .drawRect(0, 0, canvas.width, canvas.height);
    white_circle = new createjs.Shape(white_graphics);
    white_circle.alpha = 0.0;

    var figmap_graphics = new createjs.Graphics();
    figmap_graphics
        .beginRadialGradientFill(['rgba(255, 0, 0, 1)', 'rgba(255, 0, 0, 0)'], [0, 0.5], 50, 50, 0, 50, 50, 100)
        .drawRect(0, 0, canvas.width, canvas.height);
    figmap = new createjs.Shape(figmap_graphics);
    figmap.alpha = 0.0;

    /* -----------------------------------------------------------------
    createjsのモデルを配置　画像の読み込み完了後に Bitmap のインスタンスを作成する
    -------------------------------------------------------------------- */
    function setLoadAllCallback(elems, callback) {
        var count = 0;
        for (var i = 0; i < elems.length; ++i) {
            elems[i].onload = function () {
                ++count;
                if (count == elems.length) {
                    // All elements have been loaded.
                    callback(elems);
                }
            };
        }
    }

    var img = new Image();
    img.src = "fr2.png";

    var baseimg = new Image();
    baseimg.src = "bg2.png";
    setLoadAllCallback([baseimg, img], function (elems) {
        bitmap = new createjs.Bitmap("fr2.png");
        bitmap.scaleX = 1.0 // x方向の拡大率変更
        bitmap.scaleY = 1.0 // y方向の拡大率変更
        bitmap.alpha = 0.0;

        basemap = new createjs.Bitmap(baseimg);
        //basemap.y = 100;
        basemap.scaleX = 1.0 // x方向の拡大率変更
        basemap.scaleY = 1.0 // y方向の拡大率変更
        basemap.alpha = 0.0;
        stage.addChild(purple_circle, red_circle, basemap, circle, bitmap, h1_point, h2_point, h3_point, white_circle, figmap);
        stage.update();

        createjs.Tween.get(circle) // ターゲットを指定
            .to({ alpha: 1 }, 2000);
        createjs.Tween.get(bitmap) // ターゲットを指定
            .to({ alpha: 1 }, 4000);
        createjs.Tween.get(basemap) // ターゲットを指定
            .to({ alpha: 1 }, 8000);

        stretch();

        // 画像の読み込みと、音の読み込み総数カウントと総数が一緒になったらStart
        if (voice_list1_num + voice_list2_num + voice_list3_num == voice_list1.length + voice_list2.length) {
            //少し待つ
            window.setTimeout(function () {
                loaded();;
            }, 2000);

        }
    });

    /* -----------------------------------------------------------------
        //ストップウォッチ
        -------------------------------------------------------------------- */
    var stopwatch_time;

    function stopWatch() {
        //o_valueが1.0を越えたらゴール
        if (o_value > 1.0) {
            playing = false;

            var voice_goal = new Audio();
            voice_goal.src = './aegi_d/d-0.mp3'; // 音声ファイルの指定
            voice_goal.load(); // audioの読み込み
            voice_goal.play();

            modal.classList.remove('hidden');
            mask.classList.remove('hidden');
            document.getElementById("close").innerHTML = "RESTART!!!"
            if (language == "ja") {
                document.getElementById("message").innerHTML = "<br><h2 align='center'>Congrats!</h2>イかせました！<br>あなたはテクニシャンです！"
            }
            else {
                document.getElementById("message").innerHTML = "<br><h2 align='center'>Congrats!</h2>GET ORGAZM!<br>You are a technician!"
            }
            document.getElementById('modal').style.backgroundImage = 'url("./girl_png/girl004.png")';

        } else {
            myStop = new Date();	// 経過時間を退避
            myTime = myStop.getTime() - myStart.getTime();	// 通算ミリ秒計算
            myS = Math.floor(myTime / 1000);	// '秒'取得
        }

        if (stopwatch_time - myS == 0) {
            playing = false;
            modal.classList.remove('hidden');
            mask.classList.remove('hidden');
            document.getElementById("close").innerHTML = "RESTART!!!"
            if (Dist1 > 5) {
                document.getElementById('modal').style.backgroundImage = 'url("./girl_png/girl002.png")';
                if (language == "ja") {
                    document.getElementById("message").innerHTML = "<br><h2 align='center'>YOU FAILED</h2>You are moving too hard. Find a place where you can feel it while moving your finger slowly, and blame it carefully.";
                }
                else {
                    document.getElementById("message").innerHTML = "<br><h2 align='center'>YOU FAILED</h2>激しく動かしすぎです。ゆっくり指を動かしながら感じる場所を探し出し、じっくり責めましょう！";
                }
            }
            else {
                document.getElementById('modal').style.backgroundImage = 'url("./girl_png/girl003.png")';
                if (language == "ja") {
                    document.getElementById("message").innerHTML = "<br><h2 align='center'>YOU FAILED</h2>Not enough blame.There is more than one place to feel.Let's blame while moving your finger to various points";
                }
                else {
                    document.getElementById("message").innerHTML = "<br><h2 align='center'>YOU FAILED</h2>責めが足りません。感じる場所は一つではありません。色々なポイントに指を動かしながら責めましょう！";
                }
            }
        }


    }

    /* -----------------------------------------------------------------    
    //徐々に元の大きさに小さくなる　＆　色の変化
    -------------------------------------------------------------------- */

    function stretch() {
        createjs.Ticker.framerate = 40
        createjs.Ticker.addEventListener("tick", function () {
            if (bitmap.scaleX > 0.3) {
                bitmap.scaleX = bitmap.scaleX - (bitmap.scaleX - 0.3) * 0.01;
            }

            bitmap.regX = bitmap.image.width / 2;
            bitmap.regY = bitmap.image.height / 2;
            bitmap.x = canvas.width * 0.5;
            bitmap.y = canvas.height * 0.5;

            // ストレッチを戻す
            if (circle.scaleX > 1) {
                circle.scaleX = circle.scaleX - (circle.scaleX - 1) * 0.02;
                circle.scaleY = circle.scaleY - (circle.scaleY - 1) * 0.02;
            }
            if (h1_point.scaleX > 1) {
                h1_point.scaleX = h1_point.scaleX - (h1_point.scaleX - 1) * 0.02;
                h1_point.scaleY = h1_point.scaleY - (h1_point.scaleY - 1) * 0.02;
                //h1_point.alpha = h1_point.scaleY - 1;
            }
            if (h2_point.scaleX > 1) {
                h2_point.scaleX = h2_point.scaleX - (h2_point.scaleX - 1) * 0.02;
                h2_point.scaleY = h2_point.scaleY - (h2_point.scaleY - 1) * 0.02;
                //h2_point.alpha = h2_point.scaleY - 1;
            }
            if (h3_point.scaleX > 1) {
                h3_point.scaleX = h3_point.scaleX - (h3_point.scaleX - 1) * 0.02;
                h3_point.scaleY = h3_point.scaleY - (h3_point.scaleY - 1) * 0.02;
                //h3_point.alpha = h3_point.scaleY - 1;
            }

            // ストレッチと共に移動
            if (h2_point_x < canvas.width * 0.5) {
                h2_point.x = canvas.width - (canvas.width - h2_point_x) * (1 + (bitmap.scaleX - 0.3) * 0.5);
            } else {
                h2_point.x = h2_point_x * (1 + (bitmap.scaleX - 0.3) * 0.5);
            }

            if (h3_point_x < canvas.width * 0.5) {
                h3_point.x = canvas.width - (canvas.width - h3_point_x) * (1 + (bitmap.scaleX - 0.3) * 0.5);
            } else {
                h3_point.x = h3_point_x * (1 + (bitmap.scaleX - 0.3) * 0.5);
            }

            // Change Color
            // let colorStart = createjs.Graphics.getHSL(new Date().getTime() / 50, 80, 80);

            // graphics
            //     .beginRadialGradientFill([colorStart, "#000000"], [0, 0.5], canvas.width * 0.5, canvas.height * 0.5, 0, canvas.width * 0.5, canvas.height * 0.5, 640)
            //     .drawRect(0, 0, canvas.width, canvas.height);

            //console.log(Dist1);
            purple_circle.alpha = (Dist0 - 10) * 0.02;
            red_circle.alpha = (Dist0 - 40) * 0.02;
            var white_val = (Dist0 - 70) * 0.02;
            if (white_val > 0.9) {
                white_val = 0.9;
            }
            white_circle.alpha = white_val;


            //// Particle Update
            if (o_value > 0.7) {
                emitParticles();
                // パーティクルを更新
            }
            updateParticles();

            // 画面を更新する
            stage.update();

            return;
        })

    }

    /* -----------------------------------------------------------------
    パーティクルメソッド
    -------------------------------------------------------------------- */
    var count = 0; // tick イベントの回数
    var MAX_LIFE = 20; // 寿命の最大値
    var particles = [];

    // パーティクルを発生させます
    function emitParticles() {
        // パーティクルの生成
        for (var i = 0; i < 2; i++) {

            // カウントの更新
            count += 1;
            // オブジェクトの作成
            var particle = new createjs.Shape();
            particle.graphics
                .beginFill(createjs.Graphics.getHSL(count, 50, 50))
                .drawCircle(0, 0, 30 * Math.random());
            stage.addChild(particle);
            particle.compositeOperation = "lighter";

            // パーティクルの発生場所
            particle.x = stage.canvas.width / 2;
            particle.y = stage.canvas.height * 1 / 3;
            particle.alpha = 0.5;

            // 動的にプロパティーを追加します。
            // 速度
            particle.vx = 30 * (Math.random() - 0.5);
            particle.vy = 30 * (Math.random() - 0.5);
            // 寿命
            particle.life = MAX_LIFE;

            particles.push(particle);
        }
    }

    // パーティクルを更新します
    function updateParticles() {
        // パーティクルの計算を行う
        for (var i = 0; i < particles.length; i++) {
            // オブジェクトの作成
            var particle = particles[i];

            // 重力
            particle.vy += 1;

            // 摩擦
            particle.vx *= 0.96;
            particle.vy *= 0.96;

            // 速度を位置に適用
            particle.x += particle.vx;
            particle.y += particle.vy;

            // 地面
            if (particle.y > stage.canvas.height) {
                particle.y = stage.canvas.height; // 行き過ぎ補正
                particle.vy *= -1; // Y軸の速度を反転
            }

            // パーティクルのサイズをライフ依存にする
            var scale = particle.life / MAX_LIFE;
            particle.scaleX = particle.scaleY = scale;

            // 寿命を減らす
            particle.life -= 1;

            // 寿命の判定
            if (particle.life <= 0) {
                // ステージから削除
                stage.removeChild(particle);

                // 配列からも削除
                particles.splice(i, 1);
            }
        }
    }


    /* -----------------------------------------------------------------
    MouseEvent クリトリスメソッド
    -------------------------------------------------------------------- */

    // circle.addEventListener("mousedown", handleDown);
    // circle.addEventListener("pressmove", handleMove);
    // circle.addEventListener("pressup", handleUp);

    // function handleDown(event) {
    //     console.log('on')
    //     circle.scaleX += 0.03;
    //     // bitmap.scaleX += 0.005;
    // }

    // function handleMove(event) {
    //     circle.scaleX += 0.03;
    //     // bitmap.scaleX += 0.005;
    // }

    // function handleUp(event) {
    //     console.log('Up');
    // }

    /* -----------------------------------------------------------------
    Stretch
    -------------------------------------------------------------------- */
    // 基本の距離
    var baseDistance = 0;
    var startTime = Date.now();
    var preX = 0, preY = 0;
    var arr = [];
    var _preX = 0, _preY = 0, _preZ = 0;
    var _arr = [];

    // 距離を測る関数
    function getDistance(event) {
        event.preventDefault();

        var touches = event.changedTouches;

        // 2本以上の指の場合だけ処理
        if (touches.length > 1) {
            // 座標1 (1本目の指)
            var x1 = touches[0].pageX;
            var y1 = touches[0].pageY;

            // 座標2 (2本目の指)
            var x2 = touches[1].pageX;
            var y2 = touches[1].pageY;

            // 2点間の距離
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }
        return 0;
    }

    //Drag中に大きくする
    function drag() {
        if (bitmap.scaleX < 1.1) {
            bitmap.scaleX = bitmap.scaleX + 0.002 + (Dist0 - 10) * 0.0001;
        }

        if (circle.scaleX < 1.5) {
            circle.scaleX = circle.scaleX + circle.scaleX * 0.01;
            circle.scaleY = circle.scaleY + circle.scaleY * 0.01;
        }
    }

    /* -----------------------------------------------------------------
    Audio 読み込み
    -------------------------------------------------------------------- */
    var voice_list1_num = 51;
    var voice_list2_num = 38
    var voice_list3_num = 35;

    var voice_list1 = [];
    for (i = 0; i < voice_list1_num; i++) {
        var voice1 = new Audio();
        voice1.src = './aegi_a/a-' + i + '.mp3'; // 音声ファイルの指定
        voice1.load(); // audioの読み込み
        voice_list1.push(voice1);
    }

    // voice_list2に集約する
    var voice_list2 = [];
    for (i = 0; i < voice_list2_num; i++) {
        var voice2 = new Audio();
        voice2.src = './aegi_b/b-' + i + '.mp3'; // 音声ファイルの指定
        voice2.load(); // audioの読み込み
        voice_list2.push(voice2);
    }

    for (i = 0; i < voice_list3_num; i++) {
        var voice3 = new Audio();
        voice3.src = './aegi_c/c-' + i + '.mp3'; // 音声ファイルの指定
        voice3.load(); // audioの読み込み
        voice_list2.push(voice3);
    }

    // ロード完了時に呼び出し
    function loaded() {
        click_func();
        loop();
        document.getElementById("close").innerHTML = "START!!!"
    }


    /* -----------------------------------------------------------------
    Update 値を監視して、常にストレッチを更新する 
    -------------------------------------------------------------------- */
    var xDist = 0;
    var yDist = 0;
    var x0 = 0;
    var y0 = 0;
    var Dist0 = 0;
    var Dist1 = 0;
    var dragging;
    var previous_num1;
    var previous_num2;

    var sesivity = 0.1;
    var voice_thread = 40;
    var _start = new Date();	// 経過時間を退避


    window.onload = function () {
        // Click ON
        //document.getElementById("canvas1").onmousedown = function (event) {
        document.getElementById("canvas1").ontouchstart = function (event) {
            //console.log('Down');

            if (event.changedTouches) {
                x0 = event.changedTouches[0].pageX;
                y0 = event.changedTouches[0].pageY;
            }
            else {
                x0 = event.pageX;
                y0 = event.pageY;
            }
            dragging = true;

            figmap.x = x0 - x_margin - 50;
            figmap.y = y0 - y_margin - 50;

            //first sound
            previous_num1 = Math.floor(Math.random() * voice_list1.length);
            voice_list1[previous_num1].currentTime = 0;
            voice_list1[previous_num1].volume = 0.4;
            voice_list1[previous_num1].play();

            if (Dist0 < voice_thread) {
                previous_num2 = Math.floor(Math.random() * voice_list2_num);
                voice_list2[previous_num2].volume = 0.8;
            } else {
                previous_num2 = Math.floor(voice_list2_num + Math.random() * voice_list3_num);
                voice_list2[previous_num2].volume = 1.0;
            }
            voice_list2[previous_num2].currentTime = voice_list2[previous_num2].duration;
        }
        //Drag Over
        //document.getElementById("canvas1").onmousemove = function (event) {
        document.getElementById("canvas1").ontouchmove = function (event) {

            //こちらは携帯用のメソッド
            if (event.changedTouches) {
                //console.log("mobile");
                xDist = event.changedTouches[0].pageX - x0;
                yDist = event.changedTouches[0].pageY - y0;
                x0 = event.changedTouches[0].pageX;
                y0 = event.changedTouches[0].pageY;

                ///////// 感度のメソッド //////////
                var point = Math.abs(xDist) + Math.abs(yDist)
                var x_margin = document.getElementById("canvas1").getBoundingClientRect().left;
                var y_margin = document.getElementById("canvas1").getBoundingClientRect().top;

                var h1_Dist = Math.sqrt(Math.pow((x0 - x_margin) - h1_point.x, 2) + Math.pow((y0 - y_margin) - h1_point.y, 2));
                var h2_Dist = Math.sqrt(Math.pow((x0 - x_margin) - h2_point.x, 2) + Math.pow((y0 - y_margin) - h2_point.y, 2));
                var h3_Dist = Math.sqrt(Math.pow((x0 - x_margin) - h3_point.x, 2) + Math.pow((y0 - y_margin) - h3_point.y, 2));

                if (figmap.alpha < 1) {
                    figmap.alpha = figmap.alpha + 0.1;
                }
                figmap.x = x0 - x_margin - 50;
                figmap.y = y0 - y_margin - 50;

                if (point < 8) {
                    drag();
                    Dist0 = Dist0 + 0.3;
                    if (h1_Dist < 10) {
                        Dist0 = Dist0 + sesivity;
                        drag();
                        if (voice_list2[previous_num2].ended) {
                            if (Dist0 < voice_thread) {
                                previous_num2 = Math.floor(Math.random() * voice_list2_num);
                                voice_list2[previous_num2].volume = 0.8;
                            } else {
                                previous_num2 = Math.floor(voice_list2_num + Math.random() * voice_list3_num);
                                voice_list2[previous_num2].volume = 1.0;
                            }
                            voice_list2[previous_num2].currentTime = 0;
                            voice_list2[previous_num2].play();
                        }
                        if (h1_point.scaleX < 4.0) {
                            h1_point.scaleX += 0.05;
                            h1_point.scaleY += 0.05;
                        }
                    }

                    if (h2_Dist < 10) {
                        Dist0 = Dist0 + sesivity;
                        drag();
                        if (voice_list2[previous_num2].ended) {
                            if (Dist0 < voice_thread) {
                                previous_num2 = Math.floor(Math.random() * voice_list2_num);
                                voice_list2[previous_num2].volume = 0.8;
                            } else {
                                previous_num2 = Math.floor(voice_list2_num + Math.random() * voice_list3_num);
                                voice_list2[previous_num2].volume = 1.0;
                            }
                            voice_list2[previous_num2].currentTime = 0;
                            voice_list2[previous_num2].play();
                        }
                        if (h2_point.scaleX < 4.0) {
                            h2_point.scaleX += 0.05;
                            h2_point.scaleY += 0.05;
                        }
                    }

                    if (h3_Dist < 10) {
                        Dist0 = Dist0 + sesivity;

                        if (voice_list2[previous_num2].ended) {
                            if (Dist0 < voice_thread) {
                                previous_num2 = Math.floor(Math.random() * voice_list2_num);
                                voice_list2[previous_num2].volume = 0.8;
                            } else {
                                previous_num2 = Math.floor(voice_list2_num + Math.random() * voice_list3_num);
                                voice_list2[previous_num2].volume = 1.0;
                            }
                            voice_list2[previous_num2].currentTime = 0;
                            voice_list2[previous_num2].play();
                        }

                        if (h3_point.scaleX < 2.0) {
                            h3_point.scaleX += 0.05;
                            h3_point.scaleY += 0.05;
                        }
                    }
                }

                drag();
                stage.update();

                ///// Sound Play
                if (voice_list2[previous_num2].ended) {
                    if (voice_list1[previous_num1].ended) {
                        previous_num1 = Math.floor(Math.random() * voice_list1.length);
                        voice_list1[previous_num1].currentTime = 0;
                        voice_list1[previous_num1].volume = 0.4;
                        voice_list1[previous_num1].play();
                    }
                }
            }
            //こちらはPC用のメソッド
            else {
                //console.log(dragging);
                if (dragging == true) {
                    xDist = event.pageX - x0;
                    yDist = event.pageY - y0;
                    x0 = event.pageX;
                    y0 = event.pageY;

                    ///////// 感度のメソッド //////////
                    var point = Math.abs(xDist) + Math.abs(yDist)
                    var x_margin = document.getElementById("canvas1").getBoundingClientRect().left;
                    var y_margin = document.getElementById("canvas1").getBoundingClientRect().top;

                    var h1_Dist = Math.sqrt(Math.pow((x0 - x_margin) - h1_point.x, 2) + Math.pow((y0 - y_margin) - h1_point.y, 2));
                    var h2_Dist = Math.sqrt(Math.pow((x0 - x_margin) - h2_point.x, 2) + Math.pow((y0 - y_margin) - h2_point.y, 2));
                    var h3_Dist = Math.sqrt(Math.pow((x0 - x_margin) - h3_point.x, 2) + Math.pow((y0 - y_margin) - h3_point.y, 2));

                    if (figmap.alpha < 1) {
                        figmap.alpha = figmap.alpha + 0.1;
                    }
                    figmap.x = x0 - x_margin - 50;
                    figmap.y = y0 - y_margin - 50;

                    stage.update();

                    if (point < 8) {
                        drag();
                        Dist0 = Dist0 + 0.3;
                        if (h1_Dist < 10) {
                            Dist0 = Dist0 + sesivity;
                            drag();
                            if (voice_list2[previous_num2].ended) {
                                if (Dist0 < voice_thread) {
                                    previous_num2 = Math.floor(Math.random() * voice_list2_num);
                                    voice_list2[previous_num2].volume = 0.8;
                                } else {
                                    previous_num2 = Math.floor(voice_list2_num + Math.random() * voice_list3_num);
                                    voice_list2[previous_num2].volume = 1.0;
                                }
                                voice_list2[previous_num2].currentTime = 0;
                                voice_list2[previous_num2].play();
                            }
                            if (h1_point.scaleX < 4.0) {
                                h1_point.scaleX += 0.05;
                                h1_point.scaleY += 0.05;
                            }
                        }

                        if (h2_Dist < 10) {
                            Dist0 = Dist0 + sesivity;
                            drag();
                            if (voice_list2[previous_num2].ended) {
                                if (Dist0 < voice_thread) {
                                    previous_num2 = Math.floor(Math.random() * voice_list2_num);
                                    voice_list2[previous_num2].volume = 0.8;
                                } else {
                                    previous_num2 = Math.floor(voice_list2_num + Math.random() * voice_list3_num);
                                    voice_list2[previous_num2].volume = 1.0;
                                }
                                voice_list2[previous_num2].currentTime = 0;
                                voice_list2[previous_num2].play();
                            }
                            if (h2_point.scaleX < 4.0) {
                                h2_point.scaleX += 0.05;
                                h2_point.scaleY += 0.05;
                            }
                        }

                        if (h3_Dist < 10) {
                            Dist0 = Dist0 + sesivity;
                            drag();
                            if (voice_list2[previous_num2].ended) {
                                if (Dist0 < voice_thread) {
                                    previous_num2 = Math.floor(Math.random() * voice_list2_num);
                                    voice_list2[previous_num2].volume = 0.8;
                                } else {
                                    previous_num2 = Math.floor(voice_list2_num + Math.random() * voice_list3_num);
                                    voice_list2[previous_num2].volume = 1.0;
                                }
                                voice_list2[previous_num2].currentTime = 0;
                                voice_list2[previous_num2].play();
                            }

                            if (h3_point.scaleX < 2.0) {
                                h3_point.scaleX += 0.05;
                                h3_point.scaleY += 0.05;
                            }
                        }
                    }

                    //Drag中に大きくする
                    drag();
                    stage.update();

                    ///// Sound Play
                    if (voice_list2[previous_num2].ended) {
                        if (voice_list1[previous_num1].ended) {
                            previous_num1 = Math.floor(Math.random() * voice_list1.length);
                            voice_list1[previous_num1].currentTime = 0;
                            voice_list1[previous_num1].volume = 0.4;
                            voice_list1[previous_num1].play();
                        }
                    }
                }
            }

            /// ストレッチ
            if (event.changedTouches) {
                if (baseDistance) {
                    // 変化後の距離
                    var movedDistance = getDistance(event);
                } else {
                    // 基本の距離
                    baseDistance = getDistance(event);
                }
                if (movedDistance / baseDistance > 0) {
                    bitmap.scaleX += 0.04;
                }
            }
        }

        //Mouse UP
        //document.getElementById("canvas1").onmouseup = function (event) {
        document.getElementById("canvas1").touchend = function (event) {
            figmap.alpha = 0.0;
            xDist = 0;
            yDist = 0;
            dragging = false;
        }

        //フォームが持つデフォルトの動作をキャンセルするメソッドです。
        //document.ontouchmove = function () { event.preventDefault(); }
    }


    function o_Watch() {
        if (figmap.alpha > 0) {
            figmap.alpha = figmap.alpha - 0.02;
        }

        ///////// 感度の減少メソッド //////////
        if (Dist0 > 0) {
            Dist0 = Dist0 - 0.2;
        } else {
            Dist0 = 0;
        }

        arr.push({ "t": Date.now() - startTime, "x": x0, "y": y0 });
        _arr.push({ "t": Date.now() - startTime, "x": xDist, "y": yDist, "z": Dist0 });

    }


    /* -----------------------------------------------------------------
    displayData 加速度データをグラフ表示する
    -------------------------------------------------------------------- */
    var o_value = 0;

    function displayData() {
        if (!_canvas || !_canvas.getContext) { return false; }
        _ctx.fillStyle = "rgb(0, 0, 0)";
        _ctx.fillRect(0, 0, _canvas.clientWidth, _canvas.clientHeight);
        _ctx.lineWidth = 1;

        // 最新から 300px 分のデータを取りだす。
        var varr = [];
        if (arr.length > _canvas.clientWidth) {
            varr = arr.slice(-_canvas.clientWidth, -1);
        } else {
            varr = arr;
        }

        //軌跡
        // for ( idx in varr ){
        //     if ( idx > canvas.clientWidth ) break;
        //     var dat = varr[idx];

        //     if(idx == 0){
        //         preX = dat.x;
        //         preY = dat.y;
        //     }

        //     // 跡を書く
        //     ctx.strokeStyle = "green";
        //     ctx.beginPath();
        //     ctx.moveTo(dat.x,dat.y);
        //     ctx.lineTo(preX,preY);
        //     ctx.stroke();

        //     preX = dat.x;
        //     preY = dat.y;
        // }

        // 加速度
        var _varr = [];
        if (_arr.length > _canvas.clientWidth) {
            _varr = _arr.slice(-_canvas.clientWidth, -1);
        } else {
            _varr = _arr;
        }

        for (idx in _varr) {
            if (idx > _canvas.clientWidth) break;

            var dat = _varr[idx];

            // X 軸加速度を赤の線で表示する
            var dx = idx;
            var dy1 = _canvas.clientHeight / 2 + dat.x * 5.0;
            _ctx.strokeStyle = "green";
            _ctx.lineWidth = 2;
            _ctx.beginPath();
            _ctx.moveTo(dx, dy1);
            _ctx.lineTo(dx - 1, _preX);
            _ctx.stroke();

            // Y 軸加速度を青の線で表示する
            var dy2 = _canvas.clientHeight / 2 + dat.y * 5.0;
            _ctx.strokeStyle = "blue";
            _ctx.lineWidth = 2;
            _ctx.beginPath();
            _ctx.moveTo(dx, dy2);
            _ctx.lineTo(dx - 1, _preY);
            _ctx.stroke();

            // Z 軸加速度を赤の線で表示する
            var dy3 = _canvas.clientHeight - dat.z;

            /////Check Limit
            _ctx.strokeStyle = "red";
            _ctx.lineWidth = 4;
            _ctx.beginPath();
            _ctx.moveTo(dx, dy3);
            if (dx == 0) {
                _ctx.lineTo(dx - 1, _canvas.clientHeight);
            } else {
                _ctx.lineTo(dx - 1, _preZ);
            }

            _ctx.stroke();

            // 次のデータを表示するときに前のデータから線を描く用
            _preX = dy1;
            _preY = dy2;
            _preZ = dy3;

            o_value = 1.0 - (dy3 / _canvas.clientHeight);

            //Time Text
            if (stopwatch_time - myS > 10) {
                _ctx.fillStyle = 'rgba(0, 255, 0)';
            } else if (stopwatch_time - myS > 5) {
                _ctx.fillStyle = 'rgba(0, 255, 255)';
            } else {
                _ctx.fillStyle = 'rgba(255, 0, 0)';
            }
            _ctx.font = '10px Arial';
            _ctx.fillText('Count Down', _canvas.clientWidth - 120, 30);  // 座標 (20, 50) にテキスト描画
            _ctx.font = '20px Arial';
            _ctx.fillText(stopwatch_time - myS, _canvas.clientWidth - 40, 30);  // 座標 (20, 50) にテキスト描画
        }


    }

    // ブラウザのレンダリングのタイミングにあわせて表示を更新
    function loop() {
        if (playing) {
            stopWatch();
            o_Watch();
            displayData();
        };
        // update();
        window.requestAnimationFrame(loop);
    };




    /* -----------------------------------------------------------------
    ピッチインピッチアウトによる拡大縮小を禁止
    -------------------------------------------------------------------- */
    document.documentElement.addEventListener('touchstart', function (e) {
        if (e.touches.length >= 2) { e.preventDefault(); }
    }, { passive: false });

</script>